<!doctype html>
<html>
<head>
<title>Test</title>
<style>
    .myCounter {
        margin: 5px;
        overflow: auto;
        white-space: nowrap;
        height: 30px;
    }
    .myProgress {
        float: right;
        margin-right: 250px;
        position: relative;
        width: 250px;
        height: 25px;
        background-color: grey;
    }
    .myBar {
        position: absolute;
        height: 100%;
        background-color: limegreen;
    }
</style>
<script type="text/javascript">
    var elapsedTotal;
    var currTime;
    var lastTime;
    var ticker;
    var focusFps = 60;
    var blurFps = 20;
    var counters = [];
    var counterNum = 0;
    var focused = true;

    var focusTime = 10;
    var blurTime = 100;
    var timeMin = 3;
    var timeMax = 100;
    var extraTime = 0;
    var extraTimeStep = 100;
    var extraTimeStepAmt = 100;

    var nextSpeedIncreaseCost = 1000;
    var nextSpeedIncreaseCostMult = 1.7;

    var resources = 0;
    var resourceMin = 10;
    var resourceMax = 500;
    var resourceMult = 25;

    var seconds = 1000;
    var minutes = 60 * seconds;    
    var hours = 60 * minutes;
    var days = 24 * hours;

    window.addEventListener('focus', function() {
        document.title = 'Focused';
        focused = true;
    }, false);

    window.addEventListener('blur', function() {
        document.title = 'Blurred';
        focused = false;
    }, false);
    
    function initCounting() {
        currTime = lastTime = Date.now();
        elapsedTotal = 0;
        ticker = window.setTimeout(incrementTicker, seconds / (focused ? focusFps : blurFps));
    }

    function incrementTicker() {
        currTime = Date.now();
        elapsedTime = currTime - lastTime;
        elapsedTotal += elapsedTime;
        lastTime = currTime;
        checkCounters(elapsedTime + extraTime);
        extraTime = 0;
        displayCounters();
        updateResources();
        ticker = window.setTimeout(incrementTicker, seconds / (focused ? focusFps : blurFps));
    }

    function spawnCounter() {
        var name = "Counter " + (++counterNum);
        var time = randomTime();
        console.log(time);
        var res = Math.floor(Math.random() * (resourceMax - resourceMin + 1) + resourceMin) * resourceMult;
        if (time > 90000) {
            console.log("The big one!")
            res *= 4;
        } else if (time > 60000) {
            console.log ("Times two!");
            res *= 2;
        } else if (time > 40000) {
            console.log("Goin up!");
            res *= 1.5;
        }
        res = Math.ceil(res);
        var newCnt = new Counter(name, time, res, addResources);
        counters.push(newCnt);
    }    

    function checkCounters(elapsedTime) {
        for (i = 0; i < counters.length; i++) {
            counter = counters[i];
            counter.elapsedTime += elapsedTime;
            if (counter.elapsedTime >= counter.runTime) {
                if (counter.func) {
                    counter.func(counter);
                }
                counters.splice(i, 1);
            }
        }
    }

    function goFaster() {
        extraTime += extraTimeStep;
    }

    function increaseSpeedStep() {
        extraTimeStep += extraTimeStepAmt;
    }

    function purchaseSpeedIncrease() {
        if (resources < nextSpeedIncreaseCost) {
            alert("Not enough resources to purchase; this shouldn't happen!");
            return;
        }
        resources -= nextSpeedIncreaseCost;
        nextSpeedIncreaseCost = Math.ceil(nextSpeedIncreaseCost * nextSpeedIncreaseCostMult);
        increaseSpeedStep();
    }

    function randomTime() {
        return Math.floor(Math.random() * (timeMax - timeMin + 1) + timeMin) * seconds;
    }

    function displayCounters() {
        out = document.getElementById("counters");
        text = "";
        for (i = 0; i < counters.length; i++) {
            counter = counters[i];
            text += "<div class='myCounter'>";
            text += "Name: " + counter.cName + ", ";
            text += "Resources: " + counter.amount + ", ";
            remainTime = counter.runTime - counter.elapsedTime;
            text += "Time remaining: " + timeFormat(remainTime);
            width = Math.round(((counter.runTime - remainTime) / counter.runTime) * 100);
            text += "<div class='myProgress'><div class='myBar' id='" + counter.cName + "' style='width:" + width + "%;'></div></div>";
            text += "</div>";            
        }
        out.innerHTML = text;
    }

    function Counter(name, time, amount, func) {
        this.cName = name;
        this.runTime = time;
        this.startTime = Date.now();
        this.elapsedTime = 0;
        this.amount = amount;
        this.func = func;
        var self = this;
        this.printName = function() {
            return self.cName;
        };
        this.getResources = function() {
            return self.amount;
        }
        if (func === undefined) {
            this.func = null;
        }
    }

    function logComplete(counter) {
        console.log(counter.printName() + " ended.");
    }

    function timeFormat(timeInMillis) {
        var time;
        var timeRemaining = timeInMillis;
        var d = Math.floor(timeRemaining / days);
        timeRemaining -= (d * days);
        var h = Math.floor(timeRemaining / hours);
        timeRemaining -= (h * hours);
        var m = Math.floor(timeRemaining / minutes);
        timeRemaining -= (m * minutes);
        var s = Math.floor(timeRemaining / seconds);
        timeRemaining -= (s * seconds);
        time = (d > 0 ? d + " days, " : "") + (h > 0 ? h + " hours, " : "") + (m > 0 ? m + " minutes, " : "") + s + "." + zeroPad(timeRemaining) + " seconds";
        return time;
    }

    function zeroPad(num) {
        var n = Math.abs(num);
        var zeros = Math.max(0, 3 - Math.floor(n).toString().length );
        var zeroString = Math.pow(10,zeros).toString().substr(1);
        if( num < 0 ) {
            zeroString = '-' + zeroString;
        }

        return zeroString+n;
    }

    function addResources(counter) {
        resources += counter.getResources();
        console.log("Resources added: " + counter.getResources());
    }

    function updateResources() {
        document.getElementById("resourceCounter").innerHTML = resources;
        document.getElementById("speedIncrease").innerHTML = extraTimeStep;
        document.getElementById("speedIncreaseNext").innerHTML = extraTimeStep + extraTimeStepAmt;
        document.getElementById("speedIncreaseCost").innerHTML = nextSpeedIncreaseCost;
        if (resources < nextSpeedIncreaseCost) {
            document.getElementById("upgrade").disabled = true;
        } else {
            document.getElementById("upgrade").disabled = false;
        }
    }
</script>
</head>
<body onload="initCounting()">
<div>Resources: <span id="resourceCounter">0</span></div>
<button onclick="spawnCounter()">Start a counter!</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="goFaster()">Go faster (<span id="speedIncrease"></span>)!</button>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button id="upgrade" onclick="purchaseSpeedIncrease()">Purchase upgrade</button> to speed  <span id="speedIncreaseNext"></span> for <span id="speedIncreaseCost"></span>.
<br />
<div id="counters"></div>

</body>
</html>