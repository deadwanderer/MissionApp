BattleClock - Controls flow of time during battle.

If (and only if), readyToAct queue is empty (no units scheduled to act, and no Effects scheduled to tick), sort all ScheduledUpdate entities by attackTime - elapsedTime, find the lowest (least time remaining before action taken), schedule them to act (resolving multiple actors as above), and subtract the elapsed time (equal to the time required for the scheduled actor to get from elapsedTime to attackTime) from all actors. 
So:

minTime = MAX_TIME
actorIDs = []
for actor in actors:
    actionTime = actor.attackTime - (elapsedTime % actor.attackTime)
    assert(actionTime >= 0) // if less than 0, then we're not properly updating all actor times each loop
    if actionTime == minTime:
        actorIDs.add(actor.ID)
    else if actionTime < minTime:
        minTime = actionTime
        actorIDs.clear()
        actorIDs.add(actor.ID)

elapsedTime += minTime
for id in actorIDs:
    readyToAct.add(getActor(id))



Each unit has a set of Abilities.

Abilities can be either Targeted or NonTargeted.

Abilities can cause immediate damage/healing, or apply Effects.

Should one-time instant attacks be another type of Effect? Have a type of effect that is analyzed on BattleClock tick (HOT/DOT), and another type analyzed on attack (for attacker and target)?

Effects can be Buffs, Debuffs, HealOverTime, or DamageOverTime,

Buffs and Debuffs can be timed (for the next 20 seconds), or value-based (for the next three turns, for the next 200 damage taken, until the next critical attack, etc.)

These can include things like haste/slow, damage dealt/taken increased/decreased, vulnerability/resistance to damage/healing/Effects, stuns, slows, crit, etc.

HealOverTime and DamageOverTime have a max duration (possibly affected by gear/stats/skills), a tickTime (shortened by haste/gear/skills), a damage/healing min and max (actual value chosen at random between min and max each tick), an optional weight (to influence the damage/healing bell curve towards max or min, will default to no-influence value).

Units may also have passive abilities, called Auras. These are untimed effects that apply for the duration of battle. They are applied at the very start of battle, before the BattleClock starts ticking. They can be the same as Effects, but are not ticked through for time advancement calculations, though they must be checked as part of the "time till attack" calculations if they apply some ticking HOT/DOT or apply on certain events (crits, stuns, heals, etc). Can this be handled behind the scenes by just having them be Effects, with the time being zero or negative?

Different types of elemental damage: 
    Holy: heals for a percentage of damage dealt.
    Fire: Increases target damage taken for a short time after attack
    Cold: Decreases target haste for a short time after attack
    Nature: Reduces target ability to dodge/parry for a time.
    Arcane: Reduces target crit chance and damage for a time
    Necrosis: Reduces target life regen and healing effects for a short time after attack

Equipment cannot be changed after start of battle, so gear stat contributions can be precalculated. However, buffs/spells/potions/effects can alter base stats (or should this not be allowed?), so is precalc useful at all?

Stats:

Brawn   (strength): Most melee damage       / parry
Brains (intellect): Magic damage            / crit chance
Finesse  (agility): Dagger/bow/gun damage   / dodge
Faith     (spirit): Resource recovery       / haste
Vitality (stamina): Health                  / resistance
Vigor     (energy): Resource capacity       / crit damage

Secondary stats:

Alacrity      (haste): Attack speed, HOT/DOT tick speed
Intensity  (crit dmg): Critical hit damage multiplier
Serendipity (crit ch): Critical hit chance
Deflection    (parry): Chance to parry (deflect) an attack that hits, reducing or nullifying damage
Avoidance     (dodge): Chance to avoid an attack, preventing it from hitting
Defense  (resistance): Reduces damage taken from <type>-based attacks

Damage types:
    Physical
    Magic:
        Holy
        Fire
        Cold
        Nature
        Arcane
        Necrosis

Gear upgrades: requires shards to improve through three tiers for each ranking.
Require special mat to ascend to next tier?
    Worn (grey) (normal drop from enemies)
    Functional (white) (base crafted level)
    Proven (green)
    Storied (blue) (highest level drop from non-boss enemies)
    Ancient (purple) (highest level drop from bosses (endgame bosses))
    Artifact (red)  (shards drop from normal endgame)
    Ascendant (orange) (Highest tier) (shards drop from heroic endgame)


Battle flow:
BEFORE CLOCK STARTS:

Load all combatants.
Apply all Auras. 
Put all combatants and all time-based Aura Effects into the timing queue.

START CLOCK
While (clock running)
    If (Battle end (all enemies OR all heroes are dead))
        Stop clock
        Victory or defeat
    Else 
        If (readyToAct list has something in it):
            Remove the first actor from the list and perform their action
        else
            Advance clock to next action time, add actor(s) to readyToAct list

Actor is a generic component that tracks time to act (tickTime for Effects, attack speed for characters), and has an Apply method. 
The Effect version handles healing/damaging the target it's applied to, and the Character version handles calling the AI (for enemies) or presenting the Abilities screen (for heroes). AI and Character attacks happen as part of this call as well, but handled by the characters.

Should the attacker calculate damage when doing an attack, then submit AttemptAttack to the target with a struct holding all damage types with attack values for each (like so:
    struct Damage {
        physical: 1337,
        holy: 700,
        fire: 0,
        cold: 0,
        nature: 250,
        arcane: 0,
        necrosis: 0,
        effects: [Slow]
        chanceToHit: 90%
    }), and the target handles whether it hits or not (rolls against attacker chanceToHit, as well as rolling against target dodge/parry chance), and handles any damage mitigation (30% physical reduction, 5% magic vulnerability, etc.) and effects applied, and sends back to the game the actual damage done?

    Or would it just be better for the game to handle the whole thing with a ResolveAttack(attacker, target) call that handles it all? Is there really any difference?

    What about AOE attacks? Need to roll attack from attacker for each target, then each target individually calcs mitigation.


Systems:
    Event System
    Quest System
        - Quests can be given from NPCs, started from certain items, and auto-start from entering an area, killing certain enemies, or from a timer or something.
        - Need to support quest completion from the same sources.
    Battle System
    Encounter System
        - Encounter Load
        - Random Encounters
        - Custom Encounters    
    Cutscene/Story System
    Save/Load System
    Leveling/XP System
        - Characters have multiple rarities, which can be upgraded.
        - Highest level(s) locked behind max-level raid and hardmode raid
        - Max level is 100, which unlocks raid and hardmode dungeons.

Mechanics: 
    Abilities
        - Character and enemy combat abilities.
        - These may include immunities, buffs, debuffs, direct damage/heal, heal/damage over time, taunts, or some combination thereof.
        - These are actively chosen or activated during battle.
    Auras
        - Auras are passive effects that are present throughout the duration or some portion of a battle. 
        - These may include buffs or debuffs to characters or enemies from some character or enemy present on the battlefield, a buff or debuff applied by a particular battle location (e.g. slow applied from a swamp location, or damage over time effect applied by lava location).
    Combos
        - A combo could be an extra effect or intensified effect which triggers from a number of different causes, including the presence of some other effect on the target (burning or bleeding, for example), the presence of some other unit on the battle field (enrage against wolves).
    Crafting
    Upgrades
    Inventory
    Character/Equipment
        - Loot 
        - Loot tables
        - Equipment/stats

World:
    Plot
        - Generally, you are a disgraced prince or princess, unfairly robbed of your throne by your conniving siblings on your father's death. You escape death, but are forced to start from nothing, washed up on the shore of a village in the hinterlands. You work to build and rebuild support, gaining an army of heroes and building bases of support to provide food, weapons, armor, and enhancements. Eventually, you gain enough power to challenge your siblings and take your rightful place as leader of your land.
    Locations
        - The Royal Castle. (your ultimate destination)
        - The Hinterlands. (your humble beginnings)
        - A deep cave system, leading to...
        - An underground fortress, home of ancient warriors.
        - The Shrouding Weald, a foggy woods, hiding...
        - Lucar's Necropolis, an ancient stone redoubt, home of necromancy and its spawn.
    Unlocks
    Characters
    Dungeons 
        - Dungeons provide increased challenge and increased reward quality while leveling. 
        - Hard-mode dungeons begin unlocking at level 50, with Champion mode dungeons available at 100 for pre-raid to (some) normal-raid-level gear and materials.
    Raids
        - After taking back your throne in a climactic battle at level cap, you find a deep fortress hidden beneath your castle, built by your ancestors in secret to imprison dragons and ancient powers. Your siblings disregarded the warnings and sought to tame and unleash these powerful entities, but only succeeded at the latter. Your band must put down these powerful foes before they destroy the whole world.
        - Level 100 content, provides extra challenge and progression after level cap. 
        - Highest levels of gear and materials can only be obtained from raid.
        - Hardmode unlocks after defeating regular mode (boss by boss, or beat whole normal mode raid to unlock hard raid?), with an additional tier from hardmode only.
    Maps
    Procedural Generation (of maps, encounters, loot)

Battle System:
    Click to select/highlight
    Click to target enemy
    Move to enemy
    Basic attack
    Turns
        - The turn system uses a weapon-attack-speed system, where weapons have a set weapon attack speed, modified by wielder stats and abilities. 
        - Next turn is determined by who's weapon is ready to attack next.
    Selectable Abilities
    Health/death
    Resolve Battle
    UI (health, mana, skills, effects)

Item System:
    Item types
        - Equippable
            - Weapons
            - Armor
            - Accessories
        - Usable
            - Potions
            - Flasks
            - Food/drink
        - Ingredients/Crafting
            - Plants/herbs for potions and Flasks
            - Ore for metalsmithing
            - Lumber for woodcrafting
            - Cloth for weaving
            - Gems/Metals for jewelcrafting and inlays
            - Essences/ether for enchanting
            - Plants/meat/spices for cooking
    Item Affixes
        - When crafting/generating equipment, affixes are the stats and abilities that generate on an item. These are also applied by enchantments, gems, and inlays.
        - Need to differentiate between enchantments, gems, and inlays. Certain affixes only come from certain sources (gems enhance stats, enchantments add special abilities or effects, inlays...?)
    Item Upgrades
        - Gear upgrades: requires shards to improve through three tiers for each ranking.
        - Require special mat to ascend to next tier?
            - Worn (grey) (normal drop from enemies)
            - Functional (white) (base crafted level)
            - Proven (green)
            - Storied (blue) (highest level drop from non-boss enemies)
            - Ancient (purple) (highest level drop from bosses (endgame bosses))
            - Artifact (red)  (shards drop from normal endgame)
            - Ascendant (orange) (Highest tier) (shards drop from heroic endgame)
    Item Crafting

    
Main Program Flow:

Start up game
New game -- Continue (from last save, if exists) -- Load/save

Character creation?

Main game states:
World (general map, moving between specific settings)
Area (specific map, exploration of certain specific setting)
Battle (arena, only place where actual combat takes place)
Camp (place to rest, craft, gear up, etc)
Menu (single manager for all menus, or individual states/screens for each menu?)

Menu screens:
Main/Start menu (new, load, continue, options, exit)
Character/game create menu
Options menu(s)
Load/Save menu
Pause menu
Inventory menu
Quest menu
